name: FFmpeg Android v2.8.15 + libfdk_aac

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y yasm nasm pkg-config wget unzip git make gcc g++ autoconf automake libtool libtool-bin

    - name: Download Android NDK r21e
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip -O ndk.zip
        unzip -q ndk.zip
        echo "NDK_PATH=$GITHUB_WORKSPACE/android-ndk-r21e" >> $GITHUB_ENV

    - name: Build libfdk_aac
      run: |
        export NDK=${{ env.NDK_PATH }}
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export SYSROOT=$TOOLCHAIN/sysroot
        export CC=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang

        git clone https://github.com/mstorsjo/fdk-aac.git
        cd fdk-aac
        libtoolize --force --copy
        autoreconf -fiv
        ./configure \
          --host=armv7a-linux-androideabi \
          --enable-shared \
          --prefix=$GITHUB_WORKSPACE/fdk-aac-android \
          CC=$CC \
          --with-sysroot=$SYSROOT
        make -j$(nproc)
        make install

    - name: Clone FFmpeg 2.8.15
      run: |
        git clone --depth 1 --branch n2.8.15 https://github.com/FFmpeg/FFmpeg.git

    - name: Build FFmpeg with libfdk_aac
      run: |
        export NDK=${{ env.NDK_PATH }}
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export SYSROOT=$TOOLCHAIN/sysroot
        export CC=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang
        export AR=$TOOLCHAIN/bin/arm-linux-androideabi-ar
        export NM=$TOOLCHAIN/bin/arm-linux-androideabi-nm

        cd FFmpeg

        ./configure \
          --target-os=android \
          --arch=arm \
          --cpu=armv7-a \
          --enable-cross-compile \
          --cc=$CC \
          --ar=$AR \
          --nm=$NM \
          --sysroot=$SYSROOT \
          --extra-cflags="-march=armv7-a -mfloat-abi=softfp -mfpu=vfpv3-d16 -DANDROID -fPIC -I$GITHUB_WORKSPACE/fdk-aac-android/include" \
          --extra-ldflags="-L$GITHUB_WORKSPACE/fdk-aac-android/lib" \
          --enable-static \
          --disable-shared \
          --enable-gpl \
          --enable-version3 \
          --enable-nonfree \
          --enable-postproc \
          --enable-avfilter \
          --enable-libfdk_aac \
          --disable-doc \
          --disable-debug \
          --disable-programs

        make -j$(nproc)

        $CC -shared -Wl,-soname,libffmpeg.so \
          -Wl,--whole-archive \
          libavcodec/libavcodec.a \
          libavformat/libavformat.a \
          libavutil/libavutil.a \
          libswresample/libswresample.a \
          libswscale/libswscale.a \
          libavfilter/libavfilter.a \
          libpostproc/libpostproc.a \
          -Wl,--no-whole-archive \
          -z noexecstack -lc -lm -lz -ldl -llog \
          -o libffmpeg.so

    - name: Upload Final Lib
      uses: actions/upload-artifact@v4
      with:
        name: libffmpeg-monolith-fdk-aac
        path: FFmpeg/libffmpeg.so
